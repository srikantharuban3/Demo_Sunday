name: AI-Powered Test Execution

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ai-test-execution:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Playwright
      run: |
        npm init -y
        npm install playwright @playwright/test
        npx playwright install
        
    - name: Install AI Test Runner
      run: |
        npm install openai
        npm install @anthropic-ai/sdk
        
    - name: Create AI Test Executor
      run: |
        cat > ai-test-executor.js << 'EOF'
        const { chromium } = require('playwright');
        const fs = require('fs');
        
        async function executeTestFromMarkdown() {
          const testSuite = fs.readFileSync('Testsuite.md', 'utf8');
          const browser = await chromium.launch({ headless: true });
          const page = await browser.newPage();
          
          // Parse test cases from markdown
          const testCases = parseTestCases(testSuite);
          const results = [];
          
          for (const testCase of testCases) {
            console.log(`Executing: ${testCase.id} - ${testCase.description}`);
            const result = await executeTestCase(page, testCase);
            results.push(result);
          }
          
          await browser.close();
          generateReport(results);
        }
        
        function parseTestCases(markdown) {
          const testCases = [];
          const lines = markdown.split('\n');
          let currentTest = null;
          
          for (const line of lines) {
            if (line.match(/^## TC \d+/)) {
              if (currentTest) testCases.push(currentTest);
              currentTest = {
                id: line.match(/TC \d+/)[0],
                description: line.replace(/^## TC \d+ - /, ''),
                steps: []
              };
            } else if (line.startsWith('- ') && currentTest) {
              currentTest.steps.push(line.substring(2));
            }
          }
          if (currentTest) testCases.push(currentTest);
          return testCases;
        }
        
        async function executeTestCase(page, testCase) {
          const result = {
            id: testCase.id,
            description: testCase.description,
            status: 'PASS',
            steps: [],
            error: null,
            timestamp: new Date().toISOString()
          };
          
          try {
            for (const step of testCase.steps) {
              console.log(`  Step: ${step}`);
              try {
                await executeStep(page, step);
                result.steps.push({ step, status: 'PASS' });
              } catch (stepError) {
                result.status = 'FAIL';
                result.error = stepError.message;
                result.steps.push({ step: step, status: 'FAIL', error: stepError.message });
                break; // Stop executing remaining steps if one fails
              }
            }
          } catch (error) {
            result.status = 'FAIL';
            result.error = error.message;
          }
          
          return result;
        }
        
        async function executeStep(page, step) {
          if (step.includes('Navigate to')) {
            const url = step.match(/`([^`]+)`/)?.[1];
            if (url) await page.goto(url);
          } else if (step.includes('Click on the Register link')) {
            await page.click('a[href*="register"]');
          } else if (step.includes('Fill the registration page')) {
            // Generate unique username
            const timestamp = Date.now();
            const username = `user${timestamp}`.substring(0, 10);
            
            await page.fill('input[name="customer.firstName"]', 'Test');
            await page.fill('input[name="customer.lastName"]', 'User');
            await page.fill('input[name="customer.address.street"]', '123 Test St');
            await page.fill('input[name="customer.address.city"]', 'Test City');
            await page.fill('input[name="customer.address.state"]', 'TS');
            await page.fill('input[name="customer.address.zipCode"]', '12345');
            await page.fill('input[name="customer.phoneNumber"]', '555-1234');
            await page.fill('input[name="customer.ssn"]', '123-45-6789');
            await page.fill('input[name="customer.username"]', username);
            await page.fill('input[name="customer.password"]', 'password123');
            await page.fill('input[name="repeatedPassword"]', 'password123');
          } else if (step.includes('submit the form')) {
            await page.click('input[type="submit"][value="Register"]');
          } else if (step.includes('Verify that welcome message')) {
            await page.waitForSelector('h1.title');
            const welcomeText = await page.textContent('h1.title');
            if (!welcomeText.includes('Welcome')) {
              throw new Error('Welcome message not found');
            }
          } else if (step.includes('Enter valid username')) {
            // Use existing registered user or create a test user
            await page.fill('input[name="username"]', 'testuser');
          } else if (step.includes('Enter valid password')) {
            await page.fill('input[name="password"]', 'password123');
          } else if (step.includes('Click on the "Log In" button')) {
            await page.click('input[type="submit"][value="Log In"]');
          } else if (step.includes('Verify that user is successfully logged in')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('Account') && !pageContent.includes('Overview')) {
              throw new Error('Login verification failed - Account page not found');
            }
          } else if (step.includes('account overview page is displayed')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('Account') && !pageContent.includes('Overview')) {
              throw new Error('Account overview page not displayed');
            }
          } else if (step.includes('Verify that "Welcome [username]" message is displayed')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('Welcome')) {
              throw new Error('Welcome message with username not found');
            }
          } else if (step.includes('Click on "Open New Account"')) {
            await page.click('a[href*="openaccount"], a:has-text("Open New Account")');
          } else if (step.includes('Select account type as "SAVINGS"')) {
            await page.selectOption('select#type', 'SAVINGS');
          } else if (step.includes('Click "Open New Account" button')) {
            await page.click('input[type="submit"][value*="Open"], button:has-text("Open New Account")');
          } else if (step.includes('Verify new account created successfully')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('successfully') && !pageContent.includes('opened') && !pageContent.includes('created')) {
              throw new Error('New account creation verification failed');
            }
          }
          
          // Wait a bit between steps
          await page.waitForTimeout(1000);
        }
        
        function generateReport(results) {
          const passedCount = results.filter(r => r.status === 'PASS').length;
          const failedCount = results.filter(r => r.status === 'FAIL').length;
          const successRate = results.length > 0 ? ((passedCount / results.length) * 100).toFixed(1) : 0;
          
          const html = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <title>AI Test Execution Report</title>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <style>
                body { 
                  font-family: 'Segoe UI', Arial, sans-serif; 
                  margin: 0; 
                  padding: 20px; 
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  min-height: 100vh;
                }
                .container { 
                  max-width: 1200px; 
                  margin: 0 auto; 
                  background: white; 
                  border-radius: 15px; 
                  box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
                  overflow: hidden; 
                }
                .header { 
                  background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); 
                  color: white; 
                  padding: 40px; 
                  text-align: center; 
                }
                .header h1 { margin: 0; font-size: 2.5em; font-weight: 300; }
                .header p { margin: 10px 0 0 0; font-size: 1.1em; opacity: 0.9; }
                .summary { 
                  display: grid; 
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                  gap: 20px; 
                  padding: 40px; 
                  background: #f8f9fa; 
                }
                .summary-card { 
                  background: white; 
                  padding: 25px; 
                  border-radius: 10px; 
                  text-align: center; 
                  box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
                }
                .summary-card h3 { margin: 0 0 15px 0; color: #333; }
                .summary-card .number { font-size: 2.5em; font-weight: bold; margin: 15px 0; }
                .passed { color: #4CAF50; }
                .failed { color: #f44336; }
                .chart-section { padding: 40px; text-align: center; background: white; }
                .chart-container { 
                  display: flex; 
                  justify-content: center; 
                  align-items: center; 
                  max-width: 500px; 
                  margin: 0 auto; 
                }
                .test-results { padding: 40px; background: #f8f9fa; }
                .test-case { 
                  margin: 25px 0; 
                  border: 1px solid #ddd; 
                  border-radius: 10px; 
                  overflow: hidden; 
                  box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
                }
                .test-header { 
                  padding: 20px 25px; 
                  font-weight: bold; 
                  display: flex; 
                  justify-content: space-between; 
                  align-items: center; 
                }
                .test-header.pass { background: linear-gradient(135deg, #e8f5e8, #d4edda); color: #2e7d32; }
                .test-header.fail { background: linear-gradient(135deg, #ffebee, #f8d7da); color: #c62828; }
                .test-steps { padding: 25px; background: white; }
                .step { 
                  margin: 15px 0; 
                  padding: 15px; 
                  border-left: 4px solid #ddd; 
                  background: #f9f9f9; 
                  border-radius: 0 5px 5px 0; 
                }
                .step.pass { border-left-color: #4CAF50; background: #f1f8e9; }
                .step.fail { border-left-color: #f44336; background: #ffebee; }
                .error { color: #d32f2f; font-style: italic; margin-top: 8px; }
                .timestamp { font-size: 0.9em; color: #666; margin-top: 10px; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1>ü§ñ AI Test Execution Report</h1>
                  <p>Generated: ${new Date().toLocaleString()}</p>
                  <p>Test Suite: ParaBank Application Testing</p>
                </div>
                
                <div class="summary">
                  <div class="summary-card">
                    <h3>Total Tests</h3>
                    <div class="number">${results.length}</div>
                  </div>
                  <div class="summary-card">
                    <h3>Passed</h3>
                    <div class="number passed">${passedCount}</div>
                  </div>
                  <div class="summary-card">
                    <h3>Failed</h3>
                    <div class="number failed">${failedCount}</div>
                  </div>
                  <div class="summary-card">
                    <h3>Success Rate</h3>
                    <div class="number">${successRate}%</div>
                  </div>
                </div>

                <div class="chart-section">
                  <h2>üìä Test Results Overview</h2>
                  <div class="chart-container">
                    <canvas id="resultsChart"></canvas>
                  </div>
                </div>

                <div class="test-results">
                  <h2>üìã Detailed Test Results</h2>
                  ${results.map(result => `
                    <div class="test-case">
                      <div class="test-header ${result.status.toLowerCase()}">
                        <span>${result.id}: ${result.description}</span>
                        <span>${result.status}</span>
                      </div>
                      <div class="test-steps">
                        <div class="timestamp">Executed: ${new Date(result.timestamp).toLocaleString()}</div>
                        ${result.error ? `<div class="error">‚ùå Error: ${result.error}</div>` : ''}
                        ${result.steps.map(step => `
                          <div class="step ${step.status.toLowerCase()}">
                            ${step.step}
                            ${step.error ? `<div class="error">Error: ${step.error}</div>` : ''}
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  `).join('')}
                </div>

                <div class="chart-section">
                  <h2>üìä Test Results Overview</h2>
                  <div class="chart-container">
                    <canvas id="resultsChart"></canvas>
                  </div>
                </div>
              </div>

              <script>
                const ctx = document.getElementById('resultsChart').getContext('2d');
                new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: ['Passed', 'Failed'],
                    datasets: [{
                      label: 'Test Results',
                      data: [${passedCount}, ${failedCount}],
                      backgroundColor: ['#4CAF50', '#f44336'],
                      borderColor: ['#45a049', '#d32f2f'],
                      borderWidth: 2,
                      borderRadius: 8
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: {
                      legend: {
                        display: false
                      },
                      title: {
                        display: true,
                        text: 'Test Execution Results',
                        font: {
                          size: 18
                        }
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        ticks: {
                          stepSize: 1
                        }
                      }
                    }
                  }
                });
              </script>
            </body>
            </html>
          `;
          
          fs.writeFileSync('test-report.html', html);
          console.log('Test report generated: test-report.html');
        }
        
        executeTestFromMarkdown().catch(console.error);
        EOF
        
    - name: Execute AI Tests
      run: node ai-test-executor.js
      
    - name: Upload Test Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-report
        path: test-report.html
        
    - name: Upload Screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: screenshots
        path: test-results/