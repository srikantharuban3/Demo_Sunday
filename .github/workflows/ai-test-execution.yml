name: AI-Powered Test Execution Engine

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ai-test-execution:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
      fail-fast: false
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js Environment
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install Dependencies
      run: |
        npm init -y
        npm install playwright @playwright/test fs-extra uuid
        npx playwright install --with-deps
        
    - name: Install AI SDKs
      run: |
        npm install openai @anthropic-ai/sdk
        
    - name: Create Enhanced AI Test Executor
      run: |
        cat > ai-test-executor.js << 'EOF'
        const { chromium, firefox, webkit } = require('playwright');
        const fs = require('fs-extra');
        const { v4: uuidv4 } = require('uuid');
        
        class AITestExecutor {
          constructor() {
            this.browser = null;
            this.page = null;
            this.testResults = [];
            this.startTime = new Date();
          }
          
          async initialize(browserType = 'chromium') {
            const browsers = { chromium, firefox, webkit };
            this.browser = await browsers[browserType].launch({ 
              headless: true,
              args: ['--no-sandbox', '--disable-dev-shm-usage']
            });
            this.page = await this.browser.newPage();
            
            await this.page.setViewportSize({ width: 1280, height: 720 });
            console.log(`üöÄ Initialized ${browserType} browser successfully`);
          }
        
        async function executeTestFromMarkdown() {
          const browserType = process.env.BROWSER || 'chromium';
          const executor = new AITestExecutor();
          
          try {
            await executor.initialize(browserType);
            const testSuite = await fs.readFile('Testsuite.md', 'utf8');
            
            // Parse test cases from markdown
            const testCases = parseTestCases(testSuite);
            console.log(`üìã Found ${testCases.length} test case(s) to execute`);
            
            const results = [];
            
            for (const testCase of testCases) {
              console.log(`\nüß™ Executing: ${testCase.id} - ${testCase.description}`);
              const result = await executeTestCase(executor.page, testCase);
              results.push(result);
              console.log(`${result.status === 'PASS' ? '‚úÖ' : '‚ùå'} ${testCase.id} - ${result.status}`);
            }
            
            await generateEnhancedReport(results, browserType);
            await executor.cleanup();
            
            const passedCount = results.filter(r => r.status === 'PASS').length;
            console.log(`\nüìä Test Summary: ${passedCount}/${results.length} tests passed`);
            
            process.exit(results.length === passedCount ? 0 : 1);
            
          } catch (error) {
            console.error(`üí• Test execution failed: ${error.message}`);
            await executor.cleanup();
            process.exit(1);
          }
        }
            const result = await executeTestCase(page, testCase);
            results.push(result);
          }
          
          await browser.close();
          generateReport(results);
        }
        
        function parseTestCases(markdown) {
          const testCases = [];
          const lines = markdown.split('\n');
          let currentTest = null;
          
          for (const line of lines) {
            if (line.match(/^## TC \d+/)) {
              if (currentTest) testCases.push(currentTest);
              currentTest = {
                id: line.match(/TC \d+/)[0],
                description: line.replace(/^## TC \d+ - /, ''),
                steps: []
              };
            } else if (line.startsWith('- ') && currentTest) {
              currentTest.steps.push(line.substring(2));
            }
          }
          if (currentTest) testCases.push(currentTest);
          return testCases;
        }
        
        async function executeTestCase(page, testCase) {
          const result = {
            id: testCase.id,
            description: testCase.description,
            status: 'PASS',
            steps: [],
            error: null,
            timestamp: new Date().toISOString()
          };
          
          try {
            for (const step of testCase.steps) {
              console.log(`  Step: ${step}`);
              await executeStep(page, step);
              result.steps.push({ step, status: 'PASS' });
            }
          } catch (error) {
            result.status = 'FAIL';
            result.error = error.message;
            result.steps.push({ step: step, status: 'FAIL', error: error.message });
          }
          
          return result;
        }
        
        async function executeStep(page, step) {
          if (step.includes('Navigate to')) {
            const url = step.match(/`([^`]+)`/)?.[1];
            if (url) await page.goto(url);
          } else if (step.includes('Click on the Register link')) {
            await page.click('a[href*="register"]');
          } else if (step.includes('Fill the registration page')) {
            // Generate unique username
            const timestamp = Date.now();
            const username = `user${timestamp}`.substring(0, 10);
            
            await page.fill('input[name="customer.firstName"]', 'Test');
            await page.fill('input[name="customer.lastName"]', 'User');
            await page.fill('input[name="customer.address.street"]', '123 Test St');
            await page.fill('input[name="customer.address.city"]', 'Test City');
            await page.fill('input[name="customer.address.state"]', 'TS');
            await page.fill('input[name="customer.address.zipCode"]', '12345');
            await page.fill('input[name="customer.phoneNumber"]', '555-1234');
            await page.fill('input[name="customer.ssn"]', '123-45-6789');
            await page.fill('input[name="customer.username"]', username);
            await page.fill('input[name="customer.password"]', 'password123');
            await page.fill('input[name="repeatedPassword"]', 'password123');
          } else if (step.includes('submit the form')) {
            await page.click('input[type="submit"][value="Register"]');
          } else if (step.includes('Verify that welcome message')) {
            await page.waitForSelector('h1.title');
            const welcomeText = await page.textContent('h1.title');
            if (!welcomeText.includes('Welcome')) {
              throw new Error('Welcome message not found');
            }
          } else if (step.includes('Enter valid username')) {
            await page.fill('input[name="username"]', 'testuser123');
          } else if (step.includes('Enter valid password')) {
            await page.fill('input[name="password"]', 'password123');
          } else if (step.includes('Click on the "Log In" button')) {
            await page.click('input[type="submit"][value="Log In"]');
          } else if (step.includes('Verify that user is successfully logged in')) {
            await page.waitForSelector('h1.title, .title');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('Account') && !pageContent.includes('Overview')) {
              throw new Error('Login verification failed - Account page not found');
            }
          } else if (step.includes('Verify that "Welcome') || step.includes('Welcome [username]')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('Welcome')) {
              throw new Error('Welcome message with username not found');
            }
          } else if (step.includes('account overview page is displayed')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('Account') && !pageContent.includes('Overview')) {
              throw new Error('Account overview page not displayed');
            }
          } else if (step.includes('Click on "Open New Account"') || step.includes('Open New Account')) {
            await page.click('a[href*="openaccount"], a:has-text("Open New Account")');
          } else if (step.includes('Select account type')) {
            await page.selectOption('select#type', 'SAVINGS');
          } else if (step.includes('Click "Open New Account" button')) {
            await page.click('input[type="submit"][value*="Open"], button:has-text("Open New Account")');
          } else if (step.includes('Verify new account created')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('successfully') && !pageContent.includes('opened')) {
              throw new Error('New account creation verification failed');
            }
          } else if (step.includes('Click on "Transfer Funds"') || step.includes('Transfer Funds')) {
            await page.click('a[href*="transfer"], a:has-text("Transfer Funds")');
          } else if (step.includes('Enter transfer amount')) {
            await page.fill('input#amount', '100');
          } else if (step.includes('Select from account')) {
            await page.selectOption('select#fromAccountId', { index: 0 });
          } else if (step.includes('Select to account')) {
            await page.selectOption('select#toAccountId', { index: 1 });
          } else if (step.includes('Click "Transfer" button')) {
            await page.click('input[type="submit"][value*="Transfer"], button:has-text("Transfer")');
          } else if (step.includes('Verify transfer successful')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('successfully') && !pageContent.includes('complete')) {
              throw new Error('Transfer verification failed');
            }
          } else if (step.includes('Click on "Bill Pay"') || step.includes('Bill Pay')) {
            await page.click('a[href*="billpay"], a:has-text("Bill Pay")');
          } else if (step.includes('Enter payee name')) {
            await page.fill('input[name="payee.name"]', 'Electric Company');
          } else if (step.includes('Enter payee address')) {
            await page.fill('input[name="payee.address.street"]', '123 Utility St');
          } else if (step.includes('Enter payee city')) {
            await page.fill('input[name="payee.address.city"]', 'Power City');
          } else if (step.includes('Enter payee state')) {
            await page.fill('input[name="payee.address.state"]', 'PC');
          } else if (step.includes('Enter payee zip')) {
            await page.fill('input[name="payee.address.zipCode"]', '12345');
          } else if (step.includes('Enter payee phone')) {
            await page.fill('input[name="payee.phoneNumber"]', '555-9876');
          } else if (step.includes('Enter payee account')) {
            await page.fill('input[name="payee.accountNumber"]', '987654321');
          } else if (step.includes('Verify payee account')) {
            await page.fill('input[name="verifyAccount"]', '987654321');
          } else if (step.includes('Enter bill amount')) {
            await page.fill('input[name="amount"]', '75.00');
          } else if (step.includes('Click "Send Payment" button')) {
            await page.click('input[type="submit"][value*="Send"], button:has-text("Send Payment")');
          } else if (step.includes('Verify bill payment successful')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('successfully') && !pageContent.includes('sent')) {
              throw new Error('Bill payment verification failed');
            }
          } else if (step.includes('Click on "Find Transactions"') || step.includes('Find Transactions')) {
            await page.click('a[href*="findtrans"], a:has-text("Find Transactions")');
          } else if (step.includes('Enter transaction ID')) {
            await page.fill('input#criteria', '12345');
          } else if (step.includes('Click "Find Transactions" button')) {
            await page.click('input[type="submit"][value*="Find"], button:has-text("Find Transactions")');
          } else if (step.includes('Verify transaction found')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('Transaction') && !pageContent.includes('Details')) {
              throw new Error('Transaction search verification failed');
            }
          } else if (step.includes('Click on "Update Contact Info"') || step.includes('Update Contact Info')) {
            await page.click('a[href*="updateprofile"], a:has-text("Update Contact Info")');
          } else if (step.includes('Update first name')) {
            await page.fill('input[name="customer.firstName"]', 'UpdatedName');
          } else if (step.includes('Click "Update Profile" button')) {
            await page.click('input[type="submit"][value*="Update"], button:has-text("Update Profile")');
          } else if (step.includes('Verify profile updated')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('successfully') && !pageContent.includes('updated')) {
              throw new Error('Profile update verification failed');
            }
          } else if (step.includes('Click on "Request Loan"') || step.includes('Request Loan')) {
            await page.click('a[href*="requestloan"], a:has-text("Request Loan")');
          } else if (step.includes('Enter loan amount')) {
            await page.fill('input#amount', '1000');
          } else if (step.includes('Enter down payment')) {
            await page.fill('input#downPayment', '100');
          } else if (step.includes('Click "Apply Now" button')) {
            await page.click('input[type="submit"][value*="Apply"], button:has-text("Apply Now")');
          } else if (step.includes('Verify loan application')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('processed') && !pageContent.includes('application')) {
              throw new Error('Loan application verification failed');
            }
          } else if (step.includes('Click on "Log Out"') || step.includes('Log Out')) {
            await page.click('a[href*="logout"], a:has-text("Log Out")');
          } else if (step.includes('Verify user logged out')) {
            await page.waitForSelector('body');
            const pageContent = await page.textContent('body');
            if (!pageContent.includes('Login') && !pageContent.includes('logged out')) {
              throw new Error('Logout verification failed');
            }
          }
          
          // Wait a bit between steps
          await page.waitForTimeout(1000);
        }
        
        function generateReport(results) {
          const html = `
            <!DOCTYPE html>
            <html>
            <head>
              <title>Test Execution Report</title>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { background: #f4f4f4; padding: 20px; border-radius: 5px; }
                .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                .pass { border-left: 5px solid #4CAF50; }
                .fail { border-left: 5px solid #f44336; }
                .chart-container { width: 400px; height: 400px; margin: 20px auto; }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>Test Execution Report</h1>
                <p>Generated: ${new Date().toLocaleString()}</p>
                <p>Total Tests: ${results.length}</p>
                <p>Passed: ${results.filter(r => r.status === 'PASS').length}</p>
                <p>Failed: ${results.filter(r => r.status === 'FAIL').length}</p>
              </div>
              
              <div class="chart-container">
                <canvas id="resultsChart"></canvas>
              </div>
              
              ${results.map(result => `
                <div class="test-case ${result.status.toLowerCase()}">
                  <h3>${result.id} - ${result.description}</h3>
                  <p><strong>Status:</strong> ${result.status}</p>
                  <p><strong>Executed:</strong> ${result.timestamp}</p>
                  ${result.error ? `<p><strong>Error:</strong> ${result.error}</p>` : ''}
                  <details>
                    <summary>Steps</summary>
                    <ul>
                      ${result.steps.map(step => `
                        <li style="color: ${step.status === 'PASS' ? 'green' : 'red'}">
                          ${step.step} - ${step.status}
                          ${step.error ? `<br><em>${step.error}</em>` : ''}
                        </li>
                      `).join('')}
                    </ul>
                  </details>
                </div>
              `).join('')}
              
              <script>
                const ctx = document.getElementById('resultsChart').getContext('2d');
                new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: ['Passed', 'Failed'],
                    datasets: [{
                      label: 'Test Results',
                      data: [${results.filter(r => r.status === 'PASS').length}, ${results.filter(r => r.status === 'FAIL').length}],
                      backgroundColor: ['#4CAF50', '#f44336']
                    }]
                  },
                  options: {
                    responsive: true,
                    scales: {
                      y: { beginAtZero: true }
                    }
                  }
                });
              </script>
            </body>
            </html>
          `;
          
          fs.writeFileSync('test-report.html', html);
          console.log('Test report generated: test-report.html');
        }
        
        executeTestFromMarkdown().catch(console.error);
          
          async cleanup() {
            if (this.browser) {
              await this.browser.close();
              console.log('üßπ Browser cleanup completed');
            }
          }
        }
        
        async function executeTestCase(page, testCase) {
          const result = {
            id: testCase.id,
            description: testCase.description,
            status: 'PASS',
            steps: [],
            error: null,
            timestamp: new Date().toISOString(),
            screenshots: []
          };
          
          try {
            for (let i = 0; i < testCase.steps.length; i++) {
              const step = testCase.steps[i];
              console.log(`  üìã Step ${i + 1}: ${step}`);
              
              try {
                await executeStep(page, step);
                result.steps.push({ step, status: 'PASS', stepNumber: i + 1 });
              } catch (stepError) {
                result.status = 'FAIL';
                result.error = stepError.message;
                result.steps.push({ step, status: 'FAIL', error: stepError.message, stepNumber: i + 1 });
                
                // Take screenshot on failure
                const screenshotPath = `failure-${testCase.id}-step${i + 1}-${Date.now()}.png`;
                await page.screenshot({ path: screenshotPath, fullPage: true });
                result.screenshots.push(screenshotPath);
                break;
              }
            }
          } catch (error) {
            result.status = 'FAIL';
            result.error = error.message;
          }
          
          return result;
        }
        
        async function generateEnhancedReport(results, browserType) {
          const totalTests = results.length;
          const passedTests = results.filter(r => r.status === 'PASS').length;
          const failedTests = totalTests - passedTests;
          const successRate = totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0;
          
          const htmlContent = `
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AI Test Execution Report - ${browserType}</title>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <style>
                  body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
                  .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
                  .header { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 40px; text-align: center; }
                  .header h1 { margin: 0; font-size: 2.8em; font-weight: 300; }
                  .header p { margin: 10px 0 0 0; font-size: 1.2em; opacity: 0.9; }
                  .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; padding: 40px; background: #f8f9fa; }
                  .summary-card { background: white; padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s; }
                  .summary-card:hover { transform: translateY(-5px); }
                  .summary-card h3 { margin: 0 0 15px 0; color: #333; font-size: 1.1em; }
                  .summary-card .number { font-size: 3em; font-weight: bold; margin: 15px 0; }
                  .passed { color: #4CAF50; }
                  .failed { color: #f44336; }
                  .chart-section { padding: 40px; text-align: center; background: white; }
                  .chart-section h2 { color: #333; margin-bottom: 30px; }
                  .chart-container { display: flex; justify-content: center; align-items: center; }
                  .test-results { padding: 40px; background: #f8f9fa; }
                  .test-results h2 { color: #333; margin-bottom: 30px; }
                  .test-case { margin: 25px 0; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  .test-header { padding: 20px 25px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
                  .test-header.passed { background: linear-gradient(135deg, #e8f5e8, #d4edda); color: #2e7d32; }
                  .test-header.failed { background: linear-gradient(135deg, #ffebee, #f8d7da); color: #c62828; }
                  .test-steps { padding: 25px; background: white; }
                  .step { margin: 15px 0; padding: 15px; border-left: 4px solid #ddd; background: #f9f9f9; border-radius: 0 5px 5px 0; }
                  .step.passed { border-left-color: #4CAF50; background: #f1f8e9; }
                  .step.failed { border-left-color: #f44336; background: #ffebee; }
                  .step-number { font-weight: bold; color: #666; }
                  .error { color: #d32f2f; font-style: italic; margin-top: 8px; padding: 8px; background: #ffcdd2; border-radius: 4px; }
                  .timestamp { font-size: 0.9em; color: #666; margin-top: 10px; }
                  .footer { background: #333; color: white; text-align: center; padding: 20px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ü§ñ AI Test Execution Report</h1>
                      <p>Browser: ${browserType.toUpperCase()} | Generated: ${new Date().toLocaleString()}</p>
                  </div>
                  
                  <div class="summary">
                      <div class="summary-card">
                          <h3>Total Tests</h3>
                          <div class="number">${totalTests}</div>
                      </div>
                      <div class="summary-card">
                          <h3>Passed</h3>
                          <div class="number passed">${passedTests}</div>
                      </div>
                      <div class="summary-card">
                          <h3>Failed</h3>
                          <div class="number failed">${failedTests}</div>
                      </div>
                      <div class="summary-card">
                          <h3>Success Rate</h3>
                          <div class="number">${successRate}%</div>
                      </div>
                  </div>

                  <div class="chart-section">
                      <h2>üìä Test Results Overview</h2>
                      <div class="chart-container">
                          <canvas id="resultsChart" width="500" height="300"></canvas>
                      </div>
                  </div>

                  <div class="test-results">
                      <h2>üìã Detailed Test Results</h2>
                      ${results.map(result => `
                          <div class="test-case">
                              <div class="test-header ${result.status.toLowerCase()}">
                                  <span>${result.id}: ${result.description}</span>
                                  <span>${result.status}</span>
                              </div>
                              <div class="test-steps">
                                  <div class="timestamp">Executed: ${new Date(result.timestamp).toLocaleString()}</div>
                                  ${result.error ? `<div class="error">‚ùå Error: ${result.error}</div>` : ''}
                                  ${result.steps.map(step => `
                                      <div class="step ${step.status.toLowerCase()}">
                                          <span class="step-number">Step ${step.stepNumber}:</span> ${step.step}
                                          ${step.error ? `<div class="error">Error: ${step.error}</div>` : ''}
                                      </div>
                                  `).join('')}
                                  ${result.screenshots.length > 0 ? `<div style="margin-top: 15px;"><strong>Screenshots:</strong> ${result.screenshots.join(', ')}</div>` : ''}
                              </div>
                          </div>
                      `).join('')}
                  </div>
                  
                  <div class="footer">
                      <p>Report generated by AI Test Execution Engine | ${new Date().toISOString()}</p>
                  </div>
              </div>

              <script>
                  const ctx = document.getElementById('resultsChart').getContext('2d');
                  new Chart(ctx, {
                      type: 'bar',
                      data: {
                          labels: ['Passed', 'Failed'],
                          datasets: [{
                              label: 'Test Results',
                              data: [${passedTests}, ${failedTests}],
                              backgroundColor: ['#4CAF50', '#f44336'],
                              borderColor: ['#45a049', '#d32f2f'],
                              borderWidth: 2,
                              borderRadius: 8
                          }]
                      },
                      options: {
                          responsive: true,
                          plugins: {
                              legend: {
                                  display: false
                              },
                              title: {
                                  display: true,
                                  text: 'Test Execution Results',
                                  font: {
                                      size: 18
                                  }
                              }
                          },
                          scales: {
                              y: {
                                  beginAtZero: true,
                                  ticks: {
                                      stepSize: 1
                                  }
                              }
                          }
                      }
                  });
              </script>
          </body>
          </html>`;
          
          await fs.writeFile(`test-report-${browserType}.html`, htmlContent);
          console.log(`üìä Enhanced HTML report generated: test-report-${browserType}.html`);
        }

        executeTestFromMarkdown();
        EOF
        
    - name: Execute AI Test Suite
      env:
        BROWSER: ${{ matrix.browser }}
      run: node ai-test-executor.js
      
    - name: Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ matrix.browser }}
        path: |
          test-report-*.html
          failure-*.png
        retention-days: 30
        
    - name: Upload Screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: screenshots-${{ matrix.browser }}
        path: |
          failure-*.png
          *.png
        retention-days: 7