name: Claude AI-Powered Test Execution

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  claude-ai-test-execution:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Dependencies
      run: |
        npm init -y
        npm install playwright @playwright/test
        npm install @anthropic-ai/sdk
        npx playwright install chromium
        
    - name: Create Claude AI Test Executor
      run: |
        cat > claude-ai-executor.js << 'EOF'
        const { chromium } = require('playwright');
        const fs = require('fs');
        const Anthropic = require('@anthropic-ai/sdk');
        
        // Initialize Claude AI (using mock for demo - replace with actual API key)
        const anthropic = new Anthropic({
          apiKey: process.env.ANTHROPIC_API_KEY || 'mock-key-for-demo'
        });
        
        async function executeTestWithClaude() {
          let browser, page;
          const results = [];
          let hasFailures = false;
          
          try {
            console.log('ü§ñ Starting Claude AI-Powered Test Execution...');
            
            const testSuite = fs.readFileSync('Testsuite.md', 'utf8');
            browser = await chromium.launch({ 
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
            });
            page = await browser.newPage();
            
            // Set viewport and user agent
            await page.setViewportSize({ width: 1280, height: 720 });
            
            // Parse test cases from markdown
            const testCases = parseTestCases(testSuite);
            console.log(`üìã Claude AI found ${testCases.length} test cases to execute`);
            
            for (let i = 0; i < testCases.length; i++) {
              const testCase = testCases[i];
              console.log(`\nüß™ Claude AI executing Test ${i + 1}/${testCases.length}: ${testCase.id} - ${testCase.description}`);
              
              const result = await executeTestCaseWithClaude(page, testCase);
              results.push(result);
              
              if (result.status === 'FAIL') {
                hasFailures = true;
                console.log(`‚ùå ${testCase.id} FAILED - Test execution will be marked as failed`);
              } else {
                console.log(`‚úÖ ${testCase.id} PASSED successfully`);
              }
            }
            
          } catch (error) {
            console.error('‚ùå Critical error in Claude AI test execution:', error.message);
            hasFailures = true;
            
            if (results.length === 0) {
              results.push({
                id: 'CRITICAL_ERROR',
                description: 'Claude AI test execution failed to start',
                status: 'FAIL',
                steps: [],
                error: error.message,
                timestamp: new Date().toISOString()
              });
            }
          } finally {
            if (browser) {
              await browser.close();
              console.log('üîí Browser closed successfully');
            }
            
            // Generate report
            generateClaudeReport(results);
            
            // Log summary
            const passed = results.filter(r => r.status === 'PASS').length;
            const failed = results.filter(r => r.status === 'FAIL').length;
            console.log(`\nüìà CLAUDE AI SUMMARY: ${passed} passed, ${failed} failed out of ${results.length} tests`);
            
            // Exit with failure if any test failed
            if (hasFailures) {
              console.log('‚ùå CLAUDE AI EXECUTION FAILED - One or more tests failed');
              process.exit(1); // Fail the pipeline
            } else {
              console.log('‚úÖ CLAUDE AI EXECUTION SUCCESSFUL - All tests passed');
              process.exit(0); // Success
            }
          }
        }
        
        function parseTestCases(markdown) {
          const testCases = [];
          const lines = markdown.split('\n');
          let currentTest = null;
          
          for (const line of lines) {
            if (line.match(/^## TC \d+/)) {
              if (currentTest) testCases.push(currentTest);
              currentTest = {
                id: line.match(/TC \d+/)[0],
                description: line.replace(/^## TC \d+ - /, ''),
                steps: []
              };
            } else if (line.startsWith('- ') && currentTest) {
              currentTest.steps.push(line.substring(2));
            }
          }
          if (currentTest) testCases.push(currentTest);
          return testCases;
        }
        
        async function executeTestCaseWithClaude(page, testCase) {
          const result = {
            id: testCase.id,
            description: testCase.description,
            status: 'PASS',
            steps: [],
            error: null,
            timestamp: new Date().toISOString(),
            claudeInsights: []
          };
          
          console.log(`üß† Claude AI analyzing test case: ${testCase.id}`);
          
          try {
            for (let stepIndex = 0; stepIndex < testCase.steps.length; stepIndex++) {
              const step = testCase.steps[stepIndex];
              console.log(`  ü§ñ Claude AI processing Step ${stepIndex + 1}: ${step}`);
              
              // Get Claude AI insights for the step
              const claudeInsight = await getClaudeInsight(step, testCase.id);
              
              try {
                await executeStepWithClaude(page, step, claudeInsight);
                result.steps.push({ 
                  stepNumber: stepIndex + 1,
                  step: step, 
                  status: 'PASS',
                  timestamp: new Date().toISOString(),
                  claudeInsight: claudeInsight
                });
                console.log(`     ‚úÖ Step ${stepIndex + 1} passed with Claude AI guidance`);
              } catch (stepError) {
                console.log(`     ‚ùå Step ${stepIndex + 1} failed: ${stepError.message}`);
                result.status = 'FAIL';
                result.error = `Step ${stepIndex + 1} failed: ${stepError.message}`;
                result.steps.push({ 
                  stepNumber: stepIndex + 1,
                  step: step, 
                  status: 'FAIL', 
                  error: stepError.message,
                  timestamp: new Date().toISOString(),
                  claudeInsight: claudeInsight
                });
                
                // CRITICAL: Stop execution and fail immediately when a step fails
                console.log(`üí• STOPPING EXECUTION: ${testCase.id} failed at step ${stepIndex + 1}`);
                break;
              }
              
              // Add delay between steps
              await page.waitForTimeout(2000);
            }
          } catch (error) {
            result.status = 'FAIL';
            result.error = error.message;
            console.log(`üí• Test case ${testCase.id} failed with error: ${error.message}`);
          }
          
          return result;
        }
        
        async function getClaudeInsight(step, testCaseId) {
          // Simulate Claude AI analysis (in real implementation, this would call Claude API)
          const insights = {
            navigation: "Claude AI recommends using robust navigation with timeout handling",
            registration: "Claude AI suggests using unique identifiers and proper form validation",
            login: "Claude AI advises implementing proper credential management",
            verification: "Claude AI recommends multiple verification strategies",
            interaction: "Claude AI suggests using smart element detection"
          };
          
          // Determine insight type based on step content
          if (step.includes('Navigate')) return insights.navigation;
          if (step.includes('register') || step.includes('Fill')) return insights.registration;
          if (step.includes('Log In') || step.includes('username') || step.includes('password')) return insights.login;
          if (step.includes('Verify')) return insights.verification;
          return insights.interaction;
        }
        
        async function executeStepWithClaude(page, step, claudeInsight) {
          const timeout = 30000;
          
          console.log(`      üß† Claude Insight: ${claudeInsight}`);
          
          try {
            if (step.includes('Navigate to')) {
              const url = step.match(/`([^`]+)`/)?.[1];
              if (url) {
                console.log(`      üåê Claude AI navigating to: ${url}`);
                await page.goto(url, { waitUntil: 'networkidle', timeout });
                await page.waitForLoadState('domcontentloaded');
              }
            } 
            else if (step.includes('Click on the Register link')) {
              console.log(`      üñ±Ô∏è Claude AI clicking Register link`);
              const registerSelectors = [
                'a[href*="register"]',
                'a:has-text("Register")',
                'text=Register',
                '[data-testid="register"]'
              ];
              
              let clicked = false;
              for (const selector of registerSelectors) {
                try {
                  await page.waitForSelector(selector, { timeout: 5000 });
                  await page.click(selector);
                  clicked = true;
                  console.log(`        ‚úì Claude AI successfully clicked: ${selector}`);
                  break;
                } catch (e) {
                  continue;
                }
              }
              if (!clicked) throw new Error('Claude AI could not find Register link');
            }
            else if (step.includes('Fill the registration page')) {
              console.log(`      üìù Claude AI filling registration form intelligently`);
              
              // Claude AI generates unique credentials
              const timestamp = Date.now().toString();
              const username = ('user' + timestamp).substring(0, 10);
              
              const fields = [
                { selector: 'input[name="customer.firstName"]', value: 'ClaudeTest', name: 'First Name' },
                { selector: 'input[name="customer.lastName"]', value: 'AIUser', name: 'Last Name' },
                { selector: 'input[name="customer.address.street"]', value: '123 AI Street', name: 'Street' },
                { selector: 'input[name="customer.address.city"]', value: 'Claude City', name: 'City' },
                { selector: 'input[name="customer.address.state"]', value: 'AI', name: 'State' },
                { selector: 'input[name="customer.address.zipCode"]', value: '12345', name: 'Zip Code' },
                { selector: 'input[name="customer.phoneNumber"]', value: '555-0199', name: 'Phone' },
                { selector: 'input[name="customer.ssn"]', value: '123-45-6789', name: 'SSN' },
                { selector: 'input[name="customer.username"]', value: username, name: 'Username' },
                { selector: 'input[name="customer.password"]', value: 'ClaudeAI123!', name: 'Password' },
                { selector: 'input[name="repeatedPassword"]', value: 'ClaudeAI123!', name: 'Confirm Password' }
              ];
              
              for (const field of fields) {
                try {
                  await page.waitForSelector(field.selector, { timeout: 5000 });
                  await page.fill(field.selector, field.value);
                  console.log(`        ‚úì Claude AI filled ${field.name}: ${field.value}`);
                } catch (e) {
                  console.log(`        ‚ö†Ô∏è Claude AI could not fill ${field.name}: ${e.message}`);
                  throw new Error(`Failed to fill ${field.name}`);
                }
              }
              
              // Store credentials for later use
              global.claudeUsername = username;
              global.claudePassword = 'ClaudeAI123!';
            }
            else if (step.includes('submit the form')) {
              console.log(`      üöÄ Claude AI submitting form`);
              const submitSelectors = [
                'input[type="submit"][value="Register"]',
                'button[type="submit"]:has-text("Register")',
                'input[value*="Register"]',
                'button:has-text("Register")'
              ];
              
              let submitted = false;
              for (const selector of submitSelectors) {
                try {
                  await page.waitForSelector(selector, { timeout: 5000 });
                  await page.click(selector);
                  submitted = true;
                  console.log(`        ‚úì Claude AI submitted using: ${selector}`);
                  break;
                } catch (e) {
                  continue;
                }
              }
              if (!submitted) throw new Error('Claude AI could not find submit button');
              
              await page.waitForLoadState('networkidle', { timeout });
            }
            else if (step.includes('Verify that welcome message')) {
              console.log(`      üîç Claude AI verifying welcome message`);
              await page.waitForTimeout(3000);
              
              const pageContent = await page.textContent('body');
              if (!pageContent.includes('Welcome') && !pageContent.includes('success')) {
                throw new Error('Claude AI verification failed: Welcome message not found');
              }
              console.log(`        ‚úì Claude AI verified welcome message successfully`);
            }
            else if (step.includes('Enter valid username')) {
              console.log(`      üë§ Claude AI entering username`);
              const username = global.claudeUsername || 'testuser123';
              await page.waitForSelector('input[name="username"]', { timeout });
              await page.fill('input[name="username"]', username);
              console.log(`        ‚úì Claude AI entered username: ${username}`);
            }
            else if (step.includes('Enter valid password')) {
              console.log(`      üîë Claude AI entering password`);
              const password = global.claudePassword || 'ClaudeAI123!';
              await page.waitForSelector('input[name="password"]', { timeout });
              await page.fill('input[name="password"]', password);
              console.log(`        ‚úì Claude AI entered password`);
            }
            else if (step.includes('Click on the "Log In" button')) {
              console.log(`      üö™ Claude AI clicking login button`);
              const loginSelectors = [
                'input[type="submit"][value="Log In"]',
                'button:has-text("Log In")',
                'input[value*="Log In"]',
                'button[type="submit"]'
              ];
              
              let clicked = false;
              for (const selector of loginSelectors) {
                try {
                  await page.waitForSelector(selector, { timeout: 5000 });
                  await page.click(selector);
                  clicked = true;
                  console.log(`        ‚úì Claude AI clicked login: ${selector}`);
                  break;
                } catch (e) {
                  continue;
                }
              }
              if (!clicked) throw new Error('Claude AI could not find login button');
              
              await page.waitForLoadState('networkidle', { timeout });
            }
            else if (step.includes('Verify that user is successfully logged in') || 
                     step.includes('account overview page is displayed')) {
              console.log(`      üè† Claude AI verifying account overview`);
              await page.waitForTimeout(3000);
              
              const pageContent = await page.textContent('body');
              const indicators = ['Account', 'Overview', 'Balance', 'Accounts Overview', 'Welcome'];
              const found = indicators.some(indicator => pageContent.includes(indicator));
              
              if (!found) throw new Error('Claude AI verification failed: Account overview not found');
              console.log(`        ‚úì Claude AI verified account overview page`);
            }
            else if (step.includes('Verify that "Welcome [username]" message is displayed')) {
              console.log(`      üëã Claude AI verifying welcome message with username`);
              await page.waitForTimeout(2000);
              
              const pageContent = await page.textContent('body');
              if (!pageContent.includes('Welcome')) {
                throw new Error('Claude AI verification failed: Welcome message with username not found');
              }
              console.log(`        ‚úì Claude AI verified welcome message with username`);
            }
            else if (step.includes('Click on "Open New Account"')) {
              console.log(`      üÜï Claude AI clicking Open New Account`);
              const selectors = [
                'a[href*="openaccount"]',
                'a:has-text("Open New Account")',
                'text=Open New Account'
              ];
              
              let clicked = false;
              for (const selector of selectors) {
                try {
                  await page.waitForSelector(selector, { timeout: 5000 });
                  await page.click(selector);
                  clicked = true;
                  console.log(`        ‚úì Claude AI clicked: ${selector}`);
                  break;
                } catch (e) {
                  continue;
                }
              }
              if (!clicked) throw new Error('Claude AI could not find Open New Account link');
              
              await page.waitForLoadState('networkidle', { timeout });
            }
            else if (step.includes('Select account type as "SAVINGS"')) {
              console.log(`      üí∞ Claude AI selecting SAVINGS account type`);
              const selectors = ['select#type', 'select[name="type"]', 'select'];
              
              let selected = false;
              for (const selector of selectors) {
                try {
                  await page.waitForSelector(selector, { timeout: 5000 });
                  await page.selectOption(selector, 'SAVINGS');
                  selected = true;
                  console.log(`        ‚úì Claude AI selected SAVINGS in: ${selector}`);
                  break;
                } catch (e) {
                  continue;
                }
              }
              if (!selected) throw new Error('Claude AI could not find account type selector');
            }
            else if (step.includes('Click "Open New Account" button')) {
              console.log(`      üéØ Claude AI clicking Open New Account button`);
              const selectors = [
                'input[type="submit"][value*="Open"]',
                'button:has-text("Open New Account")',
                'input[value*="Open"]'
              ];
              
              let clicked = false;
              for (const selector of selectors) {
                try {
                  await page.waitForSelector(selector, { timeout: 5000 });
                  await page.click(selector);
                  clicked = true;
                  console.log(`        ‚úì Claude AI clicked: ${selector}`);
                  break;
                } catch (e) {
                  continue;
                }
              }
              if (!clicked) throw new Error('Claude AI could not find Open New Account button');
              
              await page.waitForLoadState('networkidle', { timeout });
            }
            else if (step.includes('Verify new account created successfully')) {
              console.log(`      ‚úÖ Claude AI verifying new account creation`);
              await page.waitForTimeout(3000);
              
              const pageContent = await page.textContent('body');
              const successIndicators = ['successfully', 'opened', 'created', 'new account', 'congratulations'];
              const found = successIndicators.some(indicator => 
                pageContent.toLowerCase().includes(indicator.toLowerCase())
              );
              
              if (!found) throw new Error('Claude AI verification failed: New account creation not confirmed');
              console.log(`        ‚úì Claude AI verified new account creation`);
            }
            
          } catch (error) {
            console.log(`      üí• Claude AI step execution failed: ${error.message}`);
            throw error;
          }
        }
        
        function generateClaudeReport(results) {
          const passedCount = results.filter(r => r.status === 'PASS').length;
          const failedCount = results.filter(r => r.status === 'FAIL').length;
          const totalTests = results.length;
          const successRate = totalTests > 0 ? ((passedCount / totalTests) * 100).toFixed(1) : 0;
          
          const html = `<!DOCTYPE html>
        <html lang="en">
        <head>
          <title>üß† Claude AI Test Execution Report</title>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { 
              font-family: 'Segoe UI', system-ui, sans-serif; 
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              min-height: 100vh;
              padding: 20px;
            }
            .container { 
              max-width: 1200px; 
              margin: 0 auto; 
              background: white; 
              border-radius: 20px; 
              box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
              overflow: hidden; 
            }
            .header { 
              background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%); 
              color: white; 
              padding: 40px; 
              text-align: center; 
            }
            .header h1 { font-size: 2.5em; font-weight: 300; margin-bottom: 10px; }
            .header p { font-size: 1.1em; opacity: 0.9; }
            .claude-badge { 
              background: rgba(255,255,255,0.2); 
              padding: 10px 20px; 
              border-radius: 25px; 
              display: inline-block; 
              margin: 15px 0; 
              font-weight: bold;
            }
            .status-badge { 
              display: inline-block; 
              padding: 8px 16px; 
              border-radius: 20px; 
              font-weight: bold; 
              margin: 10px 5px; 
            }
            .status-pass { background: #e8f5e8; color: #2e7d32; }
            .status-fail { background: #ffebee; color: #c62828; }
            .summary { 
              display: grid; 
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
              gap: 30px; 
              padding: 40px; 
              background: #f8f9fa; 
            }
            .summary-card { 
              background: white; 
              padding: 30px; 
              border-radius: 15px; 
              text-align: center; 
              box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
              transition: transform 0.3s ease;
              border-top: 4px solid #FF6B35;
            }
            .summary-card:hover { transform: translateY(-5px); }
            .summary-card h3 { margin-bottom: 15px; color: #333; font-size: 1.1em; }
            .summary-card .number { font-size: 3em; font-weight: bold; margin: 20px 0; }
            .passed { color: #4CAF50; }
            .failed { color: #f44336; }
            .total { color: #2196F3; }
            .rate { color: #FF9800; }
            .chart-section { 
              padding: 40px; 
              text-align: center; 
              background: white; 
            }
            .chart-container { 
              max-width: 600px; 
              margin: 20px auto; 
            }
            .test-results { 
              padding: 40px; 
              background: #f8f9fa; 
            }
            .test-case { 
              margin: 30px 0; 
              border-radius: 15px; 
              overflow: hidden; 
              box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
              background: white;
            }
            .test-header { 
              padding: 25px 30px; 
              font-weight: bold; 
              display: flex; 
              justify-content: space-between; 
              align-items: center; 
            }
            .test-header.pass { background: linear-gradient(135deg, #e8f5e8, #d4edda); color: #2e7d32; }
            .test-header.fail { background: linear-gradient(135deg, #ffebee, #f8d7da); color: #c62828; }
            .test-steps { 
              padding: 30px; 
            }
            .step { 
              margin: 20px 0; 
              padding: 20px; 
              border-left: 4px solid #ddd; 
              background: #f9f9f9; 
              border-radius: 0 10px 10px 0; 
              transition: all 0.3s ease;
            }
            .step:hover { transform: translateX(5px); }
            .step.pass { border-left-color: #4CAF50; background: #f1f8e9; }
            .step.fail { border-left-color: #f44336; background: #ffebee; }
            .step-header { 
              display: flex; 
              justify-content: space-between; 
              align-items: center; 
              margin-bottom: 10px; 
            }
            .step-number { 
              background: #FF6B35; 
              color: white; 
              border-radius: 50%; 
              width: 30px; 
              height: 30px; 
              display: flex; 
              align-items: center; 
              justify-content: center; 
              font-weight: bold; 
              font-size: 0.9em; 
            }
            .claude-insight {
              background: #fff3e0;
              border: 1px solid #ffcc02;
              border-radius: 8px;
              padding: 12px;
              margin: 10px 0;
              font-style: italic;
              color: #e65100;
            }
            .claude-insight::before {
              content: "üß† Claude AI Insight: ";
              font-weight: bold;
              color: #FF6B35;
            }
            .error { 
              color: #d32f2f; 
              font-style: italic; 
              margin-top: 10px; 
              padding: 10px; 
              background: #ffebee; 
              border-radius: 5px; 
            }
            .timestamp { 
              font-size: 0.9em; 
              color: #666; 
              margin-top: 15px; 
            }
            .execution-info {
              background: #e3f2fd;
              padding: 20px;
              margin: 20px 0;
              border-radius: 10px;
              border-left: 4px solid #FF6B35;
            }
            .fail-indicator {
              background: #ffebee;
              border: 2px solid #f44336;
              border-radius: 10px;
              padding: 20px;
              margin: 20px 0;
              text-align: center;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>üß† Claude AI Test Execution Report</h1>
              <div class="claude-badge">Powered by Claude AI LLM</div>
              <p>Intelligent Test Automation with Fail-Fast Strategy</p>
              <p>Generated: ${new Date().toLocaleString()}</p>
              <div>
                <span class="status-badge ${failedCount === 0 ? 'status-pass' : 'status-fail'}">
                  Pipeline: ${failedCount === 0 ? 'SUCCESS' : 'FAILED'}
                </span>
              </div>
            </div>
            
            ${failedCount > 0 ? `
            <div class="fail-indicator">
              <h2>‚ùå TEST EXECUTION FAILED</h2>
              <p>Claude AI detected ${failedCount} failed test(s). Pipeline marked as FAILED.</p>
            </div>
            ` : ''}
            
            <div class="summary">
              <div class="summary-card">
                <h3>üìä Total Tests</h3>
                <div class="number total">${totalTests}</div>
              </div>
              <div class="summary-card">
                <h3>‚úÖ Passed</h3>
                <div class="number passed">${passedCount}</div>
              </div>
              <div class="summary-card">
                <h3>‚ùå Failed</h3>
                <div class="number failed">${failedCount}</div>
              </div>
              <div class="summary-card">
                <h3>üìà Success Rate</h3>
                <div class="number rate">${successRate}%</div>
              </div>
            </div>

            <div class="chart-section">
              <h2>üìä Claude AI Test Results</h2>
              <div class="chart-container">
                <canvas id="resultsChart"></canvas>
              </div>
            </div>

            <div class="test-results">
              <h2>üìã Detailed Claude AI Test Results</h2>
              
              <div class="execution-info">
                <h3>üß† Claude AI Execution Information</h3>
                <p><strong>AI Model:</strong> Claude LLM (Anthropic)</p>
                <p><strong>Test Suite:</strong> ParaBank Application Testing</p>
                <p><strong>Execution Strategy:</strong> Fail-Fast with AI Insights</p>
                <p><strong>Browser:</strong> Chromium (Headless)</p>
                <p><strong>Pipeline Behavior:</strong> Fails on any test failure</p>
              </div>
              
              ${results.map((result, index) => `
                <div class="test-case">
                  <div class="test-header ${result.status.toLowerCase()}">
                    <span>üß™ ${result.id}: ${result.description}</span>
                    <span>${result.status === 'PASS' ? '‚úÖ' : '‚ùå'} ${result.status}</span>
                  </div>
                  <div class="test-steps">
                    <div class="timestamp">
                      üïí Claude AI Executed: ${new Date(result.timestamp).toLocaleString()}
                    </div>
                    ${result.error ? `
                      <div class="error">
                        ‚ö†Ô∏è <strong>Claude AI Error:</strong> ${result.error}
                      </div>
                    ` : ''}
                    
                    ${result.steps.length > 0 ? `
                      <h4 style="margin: 20px 0 15px 0; color: #333;">ü§ñ Claude AI Execution Steps:</h4>
                      ${result.steps.map(step => `
                        <div class="step ${step.status.toLowerCase()}">
                          <div class="step-header">
                            <div style="display: flex; align-items: center; gap: 15px;">
                              <div class="step-number">${step.stepNumber || '?'}</div>
                              <span style="font-weight: 500;">${step.step}</span>
                            </div>
                            <span style="font-weight: bold; color: ${step.status === 'PASS' ? '#4CAF50' : '#f44336'};">
                              ${step.status === 'PASS' ? '‚úÖ' : '‚ùå'} ${step.status}
                            </span>
                          </div>
                          ${step.claudeInsight ? `<div class="claude-insight">${step.claudeInsight}</div>` : ''}
                          ${step.error ? `<div class="error">‚ùå <strong>Step Error:</strong> ${step.error}</div>` : ''}
                          ${step.timestamp ? `<div class="timestamp">‚è∞ ${new Date(step.timestamp).toLocaleString()}</div>` : ''}
                        </div>
                      `).join('')}
                    ` : `
                      <div class="error">
                        ‚ö†Ô∏è Claude AI could not execute any steps due to test case failure
                      </div>
                    `}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <script>
            const ctx = document.getElementById('resultsChart').getContext('2d');
            new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: ['‚úÖ Passed', '‚ùå Failed'],
                datasets: [{
                  data: [${passedCount}, ${failedCount}],
                  backgroundColor: ['#4CAF50', '#f44336'],
                  borderColor: ['#45a049', '#d32f2f'],
                  borderWidth: 3,
                  hoverOffset: 10
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      font: {
                        size: 14
                      },
                      padding: 20
                    }
                  },
                  title: {
                    display: true,
                    text: 'Claude AI Test Results Distribution',
                    font: {
                      size: 18,
                      weight: 'bold'
                    },
                    padding: 20
                  }
                }
              }
            });
          </script>
        </body>
        </html>`;
          
          fs.writeFileSync('claude-test-report.html', html);
          console.log('üß† Claude AI test report generated: claude-test-report.html');
        }
        
        // Execute Claude AI tests
        executeTestWithClaude()
          .then(() => {
            console.log('üéâ Claude AI test execution completed successfully!');
          })
          .catch((error) => {
            console.error('‚ùå Claude AI execution error:', error.message);
            process.exit(1); // Ensure pipeline fails
          });
        EOF
        
    - name: Execute Claude AI Tests
      run: |
        echo "üß† Starting Claude AI-Powered Test Execution..."
        node claude-ai-executor.js
        echo "ü§ñ Claude AI test execution completed"
        
    - name: Upload Claude AI Test Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: claude-ai-test-report-${{ github.run_number }}
        path: claude-test-report.html
        retention-days: 30
        
    - name: Check Test Results
      if: always()
      run: |
        echo "üß† Claude AI Test Results Analysis:"
        echo "=================================="
        if [ -f "claude-test-report.html" ]; then
          echo "‚úÖ Claude AI test report generated successfully"
          echo "üìÅ Report available in artifacts: claude-ai-test-report-${{ github.run_number }}"
        else
          echo "‚ùå Claude AI test report not found"
          exit 1
        fi
        
        # Check if any tests failed by examining exit codes
        echo "üîç Checking for test failures..."
        # The test executor will exit with code 1 if any tests failed