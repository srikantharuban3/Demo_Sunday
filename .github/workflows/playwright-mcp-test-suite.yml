name: Playwright MCP Test Suite

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  run-mcp-playwright-tests:
    name: Execute Playwright Tests via MCP (Claude Integrated)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libdrm-dev libxkbcommon-dev libgtk-3-dev

      - name: Install Dependencies
        run: |
          npm init -y
          npm install playwright @playwright/test
          npx playwright install --with-deps

      - name: Create Test Execution Script
        run: |
          mkdir -p reports
          cat > test-executor.js << 'EOF'
          const { chromium } = require('playwright');
          const fs = require('fs');
          
          async function executeTests() {
            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext();
            const page = await context.newPage();
            
            const results = [];
            const startTime = new Date();
            
            try {
              // TC001 - Registration Test
              console.log('Executing TC001 - User Registration Test');
              
              await page.goto('https://parabank.parasoft.com/parabank/index.htm');
              await page.waitForLoadState('networkidle');
              
              // Click Register link
              await page.click('a[href*="register"]');
              await page.waitForSelector('input[name="customer.firstName"]');
              
              // Generate unique username
              const timestamp = Date.now().toString().slice(-6);
              const username = `user${timestamp}`;
              
              // Fill registration form
              await page.fill('input[name="customer.firstName"]', 'Test');
              await page.fill('input[name="customer.lastName"]', 'User');
              await page.fill('input[name="customer.username"]', username);
              await page.fill('input[name="customer.password"]', 'TestPass123!');
              await page.fill('input[name="repeatedPassword"]', 'TestPass123!');
              await page.fill('input[name="customer.address.street"]', '123 Test St');
              await page.fill('input[name="customer.address.city"]', 'Test City');
              await page.fill('input[name="customer.address.state"]', 'CA');
              await page.fill('input[name="customer.address.zipCode"]', '12345');
              await page.fill('input[name="customer.phoneNumber"]', '555-1234');
              await page.fill('input[name="customer.ssn"]', '123-45-6789');
              
              // Submit registration
              await page.click('input[type="submit"][value="Register"]');
              await page.waitForTimeout(3000);
              
              // Verify welcome message
              const welcomeText = await page.textContent('body');
              const isWelcomeDisplayed = welcomeText.includes('Welcome') || welcomeText.includes(username);
              
              results.push({
                testId: 'TC001',
                description: 'Verify that user can register a new customer',
                status: isWelcomeDisplayed ? 'PASS' : 'FAIL',
                steps: [
                  'Navigate to ParaBank homepage',
                  'Click Register link',
                  'Fill registration form with unique username',
                  'Submit registration',
                  'Verify welcome message displayed'
                ],
                timestamp: new Date().toISOString(),
                error: isWelcomeDisplayed ? null : 'Welcome message not found'
              });
              
            } catch (error) {
              results.push({
                testId: 'TC001',
                description: 'Verify that user can register a new customer',
                status: 'FAIL',
                steps: ['Test execution failed'],
                timestamp: new Date().toISOString(),
                error: error.message
              });
            }
            
            await browser.close();
            
            // Generate HTML Report
            const endTime = new Date();
            const duration = endTime - startTime;
            const passCount = results.filter(r => r.status === 'PASS').length;
            const failCount = results.filter(r => r.status === 'FAIL').length;
            
            const htmlReport = `
            <!DOCTYPE html>
            <html>
            <head>
              <title>Playwright MCP Test Execution Report</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { background: #f0f0f0; padding: 20px; border-radius: 5px; }
                .summary { margin: 20px 0; }
                .test-case { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
                .pass { background: #d4edda; border-color: #c3e6cb; }
                .fail { background: #f8d7da; border-color: #f5c6cb; }
                .chart { margin: 20px 0; }
                .bar { display: inline-block; height: 30px; margin: 5px; text-align: center; line-height: 30px; color: white; }
                .pass-bar { background: #28a745; }
                .fail-bar { background: #dc3545; }
              </style>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            </head>
            <body>
              <div class="header">
                <h1>Playwright MCP Test Execution Report</h1>
                <p><strong>Execution Time:</strong> ${startTime.toISOString()}</p>
                <p><strong>Duration:</strong> ${duration}ms</p>
                <p><strong>Total Tests:</strong> ${results.length}</p>
              </div>
              
              <div class="summary">
                <h2>Test Summary</h2>
                <div class="chart">
                  <div class="bar pass-bar" style="width: ${(passCount/results.length)*200}px;">
                    PASS: ${passCount}
                  </div>
                  <div class="bar fail-bar" style="width: ${(failCount/results.length)*200}px;">
                    FAIL: ${failCount}
                  </div>
                </div>
                <canvas id="resultsChart" width="400" height="200"></canvas>
              </div>
              
              <div class="test-results">
                <h2>Test Case Details</h2>
                ${results.map(result => `
                  <div class="test-case ${result.status.toLowerCase()}">
                    <h3>${result.testId}: ${result.description}</h3>
                    <p><strong>Status:</strong> ${result.status}</p>
                    <p><strong>Timestamp:</strong> ${result.timestamp}</p>
                    <p><strong>Steps:</strong></p>
                    <ul>
                      ${result.steps.map(step => `<li>${step}</li>`).join('')}
                    </ul>
                    ${result.error ? `<p><strong>Error:</strong> ${result.error}</p>` : ''}
                  </div>
                `).join('')}
              </div>
              
              <script>
                const ctx = document.getElementById('resultsChart').getContext('2d');
                new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: ['PASS', 'FAIL'],
                    datasets: [{
                      label: 'Test Results',
                      data: [${passCount}, ${failCount}],
                      backgroundColor: ['#28a745', '#dc3545']
                    }]
                  },
                  options: {
                    responsive: true,
                    scales: {
                      y: { beginAtZero: true }
                    }
                  }
                });
              </script>
            </body>
            </html>
            `;
            
            fs.writeFileSync('./reports/test-execution-report.html', htmlReport);
            console.log('Test execution completed. Report generated at ./reports/test-execution-report.html');
            
            // Exit with appropriate code
            process.exit(failCount > 0 ? 1 : 0);
          }
          
          executeTests().catch(error => {
            console.error('Test execution failed:', error);
            process.exit(1);
          });
          EOF

      - name: Execute Test Suite
        run: node test-executor.js

      - name: Upload HTML Test Report
        uses: actions/upload-artifact@v4
        with:
          name: Playwright-MCP-Test-Report
          path: ./reports/test-execution-report.html