name: AI-Generated Playwright Test Runner

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  ai-test-execution:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install Dependencies
      - name: Install Playwright and AI SDKs
        run: |
          npm init -y
          npm install playwright @playwright/test
          npm install openai
          npm install @anthropic-ai/sdk
          npx playwright install

      # 4ï¸âƒ£ Generate Test Cases using AI
      - name: Generate Testsuite.md using OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > generate-tests.js << 'EOF'
          import fs from 'fs';
          import OpenAI from "openai";

          const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

          async function generateTests() {
            const requirements = fs.existsSync('requirements.md')
              ? fs.readFileSync('requirements.md', 'utf8')
              : "User should be able to register and login to the application.";

            console.log("ğŸ§  Generating test cases from requirements using OpenAI...");

            const prompt = `
            Convert the following functional requirements into a set of Playwright-style manual test cases in Markdown.
            Format each test as:
            ## TC <number> - <description>
            - Step 1
            - Step 2
            - Expected Result

            Requirements:
            ${requirements}
            `;

            const completion = await client.chat.completions.create({
              model: "gpt-4o-mini",
              messages: [{ role: "user", content: prompt }],
              temperature: 0.3,
            });

            const markdown = completion.choices[0].message.content;
            fs.writeFileSync("Testsuite.md", markdown);
            console.log("âœ… Testsuite.md created successfully!");
          }

          generateTests().catch(err => {
            console.error("Error generating test cases:", err);
            process.exit(1);
          });
          EOF

          node generate-tests.js

      # 5ï¸âƒ£ Create AI Test Executor Script
      - name: Create AI Test Executor
        run: |
          cat > ai-test-executor.js << 'EOF'
          const { chromium } = require('playwright');
          const fs = require('fs');

          async function executeTestFromMarkdown() {
            const testSuite = fs.readFileSync('Testsuite.md', 'utf8');
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();

            const testCases = parseTestCases(testSuite);
            const results = [];

            for (const testCase of testCases) {
              console.log(\`Executing: \${testCase.id} - \${testCase.description}\`);
              const result = await executeTestCase(page, testCase);
              results.push(result);
            }

            await browser.close();
            generateReport(results);
          }

          function parseTestCases(markdown) {
            const testCases = [];
            const lines = markdown.split('\\n');
            let currentTest = null;

            for (const line of lines) {
              if (line.match(/^## TC \\d+/)) {
                if (currentTest) testCases.push(currentTest);
                currentTest = {
                  id: line.match(/TC \\d+/)[0],
                  description: line.replace(/^## TC \\d+ - /, ''),
                  steps: []
                };
              } else if (line.startsWith('- ') && currentTest) {
                currentTest.steps.push(line.substring(2));
              }
            }

            if (currentTest) testCases.push(currentTest);
            return testCases;
          }

          async function executeTestCase(page, testCase) {
            const result = {
              id: testCase.id,
              description: testCase.description,
              status: 'PASS',
              steps: [],
              error: null,
              timestamp: new Date().toISOString()
            };

            try {
              for (const step of testCase.steps) {
                console.log(\`  Step: \${step}\`);
                await executeStep(page, step);
                result.steps.push({ step, status: 'PASS' });
              }
            } catch (error) {
              result.status = 'FAIL';
              result.error = error.message;
              result.steps.push({ step: step, status: 'FAIL', error: error.message });
            }

            return result;
          }

          async function executeStep(page, step) {
            if (step.includes('Navigate to')) {
              const url = step.match(/`([^`]+)`/)?.[1];
              if (url) await page.goto(url);
            } else if (step.includes('Click on the Register link')) {
              await page.click('a[href*="register"]');
            } else if (step.includes('Fill the registration page')) {
              const timestamp = Date.now();
              const username = \`user\${timestamp}\`.substring(0, 10);

              await page.fill('input[name="customer.firstName"]', 'Test');
              await page.fill('input[name="customer.lastName"]', 'User');
              await page.fill('input[name="customer.address.street"]', '123 Test St');
              await page.fill('input[name="customer.address.city"]', 'Test City');
              await page.fill('input[name="customer.address.state"]', 'TS');
              await page.fill('input[name="customer.address.zipCode"]', '12345');
              await page.fill('input[name="customer.phoneNumber"]', '555-1234');
              await page.fill('input[name="customer.ssn"]', '123-45-6789');
              await page.fill('input[name="customer.username"]', username);
              await page.fill('input[name="customer.password"]', 'password123');
              await page.fill('input[name="repeatedPassword"]', 'password123');
            } else if (step.includes('submit the form')) {
              await page.click('input[type="submit"][value="Register"]');
            } else if (step.includes('Verify that welcome message')) {
              await page.waitForSelector('h1.title');
              const welcomeText = await page.textContent('h1.title');
              if (!welcomeText.includes('Welcome')) {
                throw new Error('Welcome message not found');
              }
            }

            await page.waitForTimeout(1000);
          }

          function generateReport(results) {
            fs.writeFileSync('results.json', JSON.stringify(results, null, 2));
            console.log('âœ… Test results saved to results.json');
          }

          executeTestFromMarkdown();
          EOF

      # 6ï¸âƒ£ Run the AI Test Executor
      - name: Run AI Test Executor
        run: node ai-test-executor.js

      # 7ï¸âƒ£ Upload test results as artifact
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: ai-test-results
          path: results.json